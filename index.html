<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Empfangsort: Transportbestätigung</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            min-height: 100vh;
            background-color: #f4f7fa;
            font-family: 'Montserrat', sans-serif;
        }
        .header-section {
            background-color: #00002d;
            color: white;
            padding: 40px;
            border-radius: 12px 12px 0 0;
        }
        .header-section h1 {
            font-weight: 700;
            font-size: 2.2rem;
        }
        .main-card {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            margin: 40px auto;
            max-width: 900px;
        }
        .login-card {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin: 100px auto;
            max-width: 450px;
            padding: 40px;
        }
        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }
        .login-header h2 {
            color: #00002d;
            font-weight: 700;
            margin-bottom: 10px;
        }
        .login-header p {
            color: #6b7280;
        }
        .form-control, .form-select {
            background-color: #f0f3f8;
            border: 1px solid #d1d5db;
            color: #1f2937;
            font-weight: 500;
            font-size: 1rem;
            height: 44px;
        }
        .form-label {
            font-weight: 600;
            color: #00002d;
            margin-bottom: 5px;
        }
        .order-card {
            border: 1px solid #e5e7eb;
            border-left: 5px solid #3b82f6;
            border-radius: 8px;
            margin-bottom: 20px;
            padding: 22px 22px 10px 22px;
            background-color: #ffffff;
        }
        .order-card h5 {
            font-weight: 700;
            color: #3b82f6;
            margin-bottom: 10px;
            border-bottom: 2px solid #f0f3f8;
            padding-bottom: 5px;
        }
        .btn-custom {
            background-color: #3b82f6;
            color: white;
            font-weight: 600;
            font-size: 1.1rem;
            padding: 10px 30px;
            border: none;
            transition: background-color 0.3s ease;
        }
        .btn-custom:hover {
            background-color: #1e3a8a;
            color: white;
        }
        .hidden {
            display: none !important;
        }
        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
            margin-right: 0.5rem;
        }
        .readonly-label {
            display: block;
            font-weight: 500;
            color: #767676;
        }
        .readonly-data {
            font-weight: 600;
            color: #1f2937;
            font-size: 1.1rem;
            margin-bottom: 13px;
        }
        .form-text {
            font-size: 0.92em;
        }
        /* Tooltip styling */
        [data-bs-toggle="tooltip"] {
            cursor: help;
        }
        /* Larger textarea for comments */
        textarea.form-control {
            min-height: 80px;
            resize: vertical;
        }
        /* Order header styling */
        .order-card h5 {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        .order-id-badge {
            background-color: #dbeafe;
            color: #1e40af;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" class="container">
        <div class="login-card">
            <div class="login-header">
                <img src="https://upload.wikimedia.org/wikipedia/commons/4/44/BMW.svg" alt="BMW Logo" style="height: 60px; margin-bottom: 20px;">
                <h2>Anmeldung erforderlich</h2>
                <p>Bitte melden Sie sich an, um auf die Transportaufträge zuzugreifen.</p>
            </div>
            <form id="login-form">
                <div class="mb-3">
                    <label for="username" class="form-label">Benutzername</label>
                    <input type="text" class="form-control" id="username" name="username" required autocomplete="username">
                </div>
                <div class="mb-4">
                    <label for="password" class="form-label">Passwort</label>
                    <input type="password" class="form-control" id="password" name="password" required autocomplete="current-password">
                </div>
                <div id="login-alert" class="mb-3"></div>
                <div class="d-grid">
                    <button type="submit" class="btn btn-custom" id="login-btn">
                        <span id="login-btn-text">Anmelden</span>
                        <span id="login-spinner" class="spinner-border spinner-border-sm hidden" role="status" aria-hidden="true"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Main Application (hidden until login) -->
    <div id="main-app" class="container hidden">
        <div class="main-card">
            <div class="header-section text-center">
                <h1>Transportbestätigung durch Empfangsort <img src="https://upload.wikimedia.org/wikipedia/commons/4/44/BMW.svg" alt="BMW Logo" style="height: 1.2em; vertical-align: middle;"></h1>
                <p class="lead" style="color: #dbeafe;">
                  Bitte bestätigen Sie als Empfangsort die empfangenen Werte zu den untenstehenden Transporten.
                </p>
            </div>
            <div class="p-4">
                <form id="delivery-form">
                    <div id="orders-container">
                        <div class="alert alert-info" role="alert">Lade Bestelldaten...</div>
                    </div>
                    <div id="alert-container" class="mt-4"></div>
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-custom mt-3">Bestätigung speichern & an Logistik senden</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const AUTH_FLOW_URL = 'https://e157ee54d75be7b59e64b3c2c12166.51.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/3f3444f8c3514fe8873204c368389636/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=SwlTj3if5ZKKomFHRBl7RZA-kmS3-X4oMm7NkNRVYFU';
        const ORDER_SUBMIT_URL = 'https://e157ee54d75be7b59e64b3c2c12166.51.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/c3b6894a81804e10a1040bf9d114ae16/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=3k9xRRQyzvzaQPioR6-EuOVGvns-Ap0jE3CYRe4C8Ys';
        
        let sessionToken = null;

        // Reason for short delivery destination options ("Reason Short Delivery Destination")
        const REASON_SHORT_DELIVERY = [
            { value: 'None', text: '— Keine Unterlieferung —' },
            { value: '05', text: '05 Falsche Waggongattung angeliefert' },
            { value: '06', text: '06 Fehlende Waggons - Schadwaggon' },
            { value: '07', text: '07 Ausrangierung Schadwaggons' },
            { value: '08', text: '08 fehlende Lokführerverfügbarkeit' },
            { value: '09', text: '09 zu wenige Waggons - falsche Planung Bahn-DL' },
            { value: '10', text: '10 zu spät angelieferte Waggons' },
            { value: '11', text: '11 Fehlende Lokführerverfügbarkeit' },
            { value: '12', text: '12 Zugverspätung - Arbeitszeit Ende' },
            { value: '13', text: '13 Zugverspätung - Sonstiges Bahn DL' },
            { value: '14', text: '14 Zugverspätung -   Sonstiges' },
            { value: '15', text: '15 Streik - Bahn Infrastruktur' },
            { value: '25', text: '25 technische Störungen Bahnhof bzw. Rangierer' },
            { value: '26', text: '26 technische Störungen auf der Strecke (z.B. Bahnübergang, Stellwerkstörung)' },
            { value: '27', text: '27 Rangierleistung nicht ausreichend - Rangierdienst unterbesetzt' },
            { value: '28', text: '28 Rangierleistung nicht ausreichend  - Rangierdienst in Pause' },
            { value: '29', text: '29 Rangierleistung nicht ausreichend - Lokschaden/ Lokstörung' },
            { value: '30', text: '30 Zeitplanung Rangierverkehr' },
            { value: '31', text: '31 Rangierleistung nicht ausreichend (z.B. bei zu viel Rangierung Schadwaggons/Züge gleichzeitig/Lokverfügbarkeit/Lokführer krank, Lokstörrung…)' },
            { value: '32', text: '32 Stellwerk nicht besetzt' },
            { value: '33', text: '33 Lokzuführung verspätet' },
            { value: '34', text: '34 Warten aus Lok - Störung auf der Strecke; Fahren auf Sicht' },
            { value: '35', text: '35 Warten auf Lok - Infrastruktur überlastet' },
            { value: '36', text: '36 Warten aus Lok - Sonstiges' },
            { value: '37', text: '37 Streckensperrung --> keine Umleitung möglich' },
            { value: '38', text: '38 Baustelle/ Infrastruktur' },
            { value: '39', text: '39 Blockierung Transportwege (Abgrenzung zur technischen Störrung, z.B. liegengebliebener Zug auf der Strecke)' },
            { value: '40', text: '40 Umleitung netzbedingt; Personen im Gleis' },
            { value: '41', text: '41 Infrastruktur (Baustellen, Oberleitungsstörung, Rückstau wg. Überfüllung der Umleitungen)' },
            { value: '42', text: '42 fehlende Trassenverfügbarkeit' },
            { value: '43', text: '43 Dispositive Zulaufsteuerung' },
            { value: '53', text: '53 Fehlende Waggons - falsche Planung Bahn-DL' }
        ];

        function showLoginAlert(message, type) {
            const alertContainer = document.getElementById('login-alert');
            // Validate type and escape message to prevent XSS
            const validType = validateAlertType(type);
            const escapedMessage = escapeHtml(message);
            alertContainer.innerHTML = `<div class="alert alert-${validType} alert-dismissible fade show" role="alert">
                                            ${escapedMessage}
                                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                        </div>`;
        }

        // Generate 2-hour time slots as options (00:00-02:00, ..., 22:00-00:00)
        function generate2HourSlots() {
            const slots = [];
            for (let h = 0; h < 24; h += 2) {
                let from = `${String(h).padStart(2, '0')}:00`;
                let toHour = (h + 2) % 24;
                let to = `${String(toHour).padStart(2, '0')}:00`;
                slots.push({
                    value: `${from} - ${to}`,
                    text: `${from} - ${to}`
                });
            }
            return slots.map(slot => `<option value="${slot.value}">${slot.text}</option>`).join('');
        }
        const twoHourSlotOptionsHtml = generate2HourSlots();

        // Escape HTML to prevent XSS attacks
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Validate alert type to prevent CSS class injection
        function validateAlertType(type) {
            const validTypes = ['success', 'danger', 'warning', 'info'];
            return validTypes.includes(type) ? type : 'info';
        }

        // Sanitize ID to ensure it only contains safe characters for HTML attributes
        function sanitizeId(id) {
            // Remove any characters that are not alphanumeric (including German umlauts), dash, or underscore
            // Allow ä, ö, ü, Ä, Ö, Ü, ß and other common European characters
            // Note: HTML5 supports non-ASCII characters in IDs. This is necessary for proper German text support.
            return String(id).replace(/[^a-zA-Z0-9\-_äöüÄÖÜß]/g, '');
        }

        // UTF-8 aware base64 decoding
        function base64DecodeUnicode(str) {
            // Convert base64 to percent-encoding, then decode
            return decodeURIComponent(atob(str).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
        }

        // Convert date from DD.MM.YYYY format to YYYY-MM-DD (ISO format)
        function convertDateToISO(dateStr) {
            if (!dateStr) return '';
            const parts = dateStr.split('.');
            if (parts.length === 3) {
                const [day, month, year] = parts;
                return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
            }
            return dateStr;
        }

        // Get/normalize order data from URL
        function getOrdersFromUrl() {
            const params = new URLSearchParams(window.location.search);
            const encodedData = params.get('data');
            try {
                if (!encodedData) return [];
                let jsonString;
                try {
                    // Try UTF-8 aware base64 decoding first
                    jsonString = base64DecodeUnicode(encodedData);
                } catch { 
                    try {
                        // Fallback to regular base64
                        jsonString = atob(encodedData);
                    } catch {
                        // Last resort: try URL decoding
                        jsonString = decodeURIComponent(encodedData);
                    }
                }
                const parsedData = JSON.parse(jsonString);
                const ordersArray = Array.isArray(parsedData) ? parsedData : [parsedData];
                return ordersArray.map(order => {
                    // Note: Handle 'Depature' typo in source data for backward compatibility
                    const departure = order.Departure || order.departure || order.Depature || 'N/A';
                    const destination = order.Destination || order.destination || 'N/A';
                    return {
                        orderId: order.OrderID || order.orderId,
                        supplier: order.SupplierName || order.supplier,
                        cw: order.CW || order.cw,
                        route: `${departure} nach ${destination}`,
                        deliveryDate: (order.deliveryDate || order.DeliveryDate || '').trim(),
                        departure: departure,
                        deliveredWagons: order.DeliveredWagons || order.deliveredWagons || '',
                        dlTransportdate: order.DlTransportdate || order.dlTransportdate || '',
                        reasonShortDelivery: order['Reason Short Delivery Destination'] || order.reasonShortDeliveryDestination || '',
                    };
                });
            } catch (e) {
                return [];
            }
        }

        function createDeliveryCard(order) {
            const id = sanitizeId(order.orderId || 'UNKNOWN');
            
            // Extract the code from the reason (e.g., "38 Baustelle/Infrastruktur" -> "38")
            const reasonCode = (order.reasonShortDelivery || '').split(' ')[0] || '';
            
            const reasonOpts = REASON_SHORT_DELIVERY.map(r => {
                const selected = r.value === reasonCode ? ' selected' : '';
                return `<option value="${escapeHtml(r.value)}"${selected}>${escapeHtml(r.text)}</option>`;
            }).join('');

            return `
                <div class="order-card" data-order-id="${id}">
                    <h5>
                        <span>${escapeHtml(order.route ? order.route : '')}</span>
                        <span class="order-id-badge">Auftrag-ID: ${escapeHtml(order.orderId || 'UNKNOWN')}</span>
                    </h5>
                    <div class="row g-3 mb-3">
                        <!-- Anzeigen nicht ändern -->
                        <div class="col-md-4 mb-1">
                            <label class="readonly-label">Dienstleister</label>
                            <span class="readonly-data">${escapeHtml(order.supplier || 'N/A')}</span>
                        </div>
                        <div class="col-md-4 mb-1">
                            <label class="readonly-label">KW</label>
                            <span class="readonly-data">${escapeHtml(order.cw || 'N/A')}</span>
                        </div>
                        <div class="col-md-4 mb-1">
                            <label class="readonly-label">Abfahrt</label>
                            <span class="readonly-data">${escapeHtml(order.departure || 'N/A')}</span>
                        </div>
                    </div>
                    <hr class="my-2">
                    <!-- Anzeigen und Änderungen eingeben -->
                    <div class="row g-3">
                        <!-- Lieferdetails Gruppe -->
                        <div class="col-md-4">
                            <label for="delivered-wagons-${id}" class="form-label">Gelieferte Waggons</label>
                            <input type="number" class="form-control" id="delivered-wagons-${id}" name="delivered-wagons-${id}" min="0" value="${escapeHtml(String(order.deliveredWagons || ''))}" required>
                        </div>
                        <div class="col-md-4">
                            <label for="delivered-transport-date-${id}" class="form-label" data-bs-toggle="tooltip" data-bs-placement="top" title="Dieses Datum ggf. am Empfangsort eintragen">Ist-Transportdatum</label>
                            <input type="date" class="form-control" id="delivered-transport-date-${id}" name="delivered-transport-date-${id}" value="${escapeHtml(convertDateToISO(order.dlTransportdate || ''))}">
                        </div>
                        <div class="col-md-4">
                            <label for="delivery-time-slot-${id}" class="form-label">Lieferzeit-Slot (2h)</label>
                            <select class="form-select" id="delivery-time-slot-${id}" name="delivery-time-slot-${id}">
                                ${twoHourSlotOptionsHtml}
                            </select>
                        </div>
                        
                        <!-- No Show und Grund Gruppe -->
                        <div class="col-md-4">
                            <label for="destination-no-show-${id}" class="form-label">No Show am Empfangsort</label>
                            <select class="form-select" id="destination-no-show-${id}" name="destination-no-show-${id}" required>
                                <option value="No">Nein</option>
                                <option value="Yes">Ja</option>
                            </select>
                        </div>
                        <div class="col-md-8">
                            <label for="reason-short-destination-${id}" class="form-label">Grund Unterlieferung Empfangsort</label>
                            <select class="form-select" id="reason-short-destination-${id}" name="reason-short-destination-${id}">${reasonOpts}</select>
                        </div>
                        
                        <!-- Kommentar Gruppe -->
                        <div class="col-12">
                            <label for="destination-comment-${id}" class="form-label">Kommentar Empfangsort</label>
                            <textarea class="form-control" id="destination-comment-${id}" name="destination-comment-${id}" maxlength="500" rows="3"></textarea>
                        </div>
                    </div>
                </div>
            `;
        }

        function loadForm() {
            const ordersData = getOrdersFromUrl();
            const container = document.getElementById('orders-container');
            container.innerHTML = '';
            if (ordersData.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-danger" role="alert">
                        <strong>Fehler:</strong> Es wurden keine Bestelldaten übergeben oder die Daten konnten nicht geladen werden.<br><br>
                        Bitte wenden Sie sich an das Logistik-Team oder überprüfen Sie den Link.
                    </div>`;
                const submitBtn = document.querySelector('#delivery-form button[type="submit"]');
                if (submitBtn) submitBtn.disabled = true;
                return;
            }
            ordersData.forEach(order => {
                container.innerHTML += createDeliveryCard(order);
            });
            // Initialize Bootstrap tooltips (dispose any existing ones first)
            const tooltipTriggerList = Array.from(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.forEach((tooltipTriggerEl) => {
                // Dispose existing tooltip if any
                const existingTooltip = bootstrap.Tooltip.getInstance(tooltipTriggerEl);
                if (existingTooltip) {
                    existingTooltip.dispose();
                }
                new bootstrap.Tooltip(tooltipTriggerEl);
            });
        }

        function showAlert(message, type) {
            const alertContainer = document.getElementById('alert-container');
            // Validate type and escape message to prevent XSS
            const validType = validateAlertType(type);
            const escapedMessage = escapeHtml(message);
            alertContainer.innerHTML = `<div class="alert alert-${validType} alert-dismissible fade show" role="alert" style="font-size: 1rem;">
                                            ${escapedMessage}
                                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                        </div>`;
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Handle Login
            document.getElementById('login-form').addEventListener('submit', async function(event) {
                event.preventDefault();
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value;
                const loginBtn = document.getElementById('login-btn');
                const loginBtnText = document.getElementById('login-btn-text');
                const loginSpinner = document.getElementById('login-spinner');
                loginBtn.disabled = true;
                loginBtnText.textContent = 'Überprüfung...';
                loginSpinner.classList.remove('hidden');
                try {
                    const response = await fetch(AUTH_FLOW_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            username: username,
                            password: password,
                            timestamp: new Date().toISOString()
                        })
                    });
                    const result = await response.json();
                    if (response.ok && result.authenticated === true) {
                        sessionToken = result.token || null;
                        document.getElementById('login-screen').classList.add('hidden');
                        document.getElementById('main-app').classList.remove('hidden');
                        loadForm();
                    } else {
                        showLoginAlert('Ungültiger Benutzername oder Passwort. Bitte versuchen Sie es erneut.', 'danger');
                        loginBtn.disabled = false;
                        loginBtnText.textContent = 'Anmelden';
                        loginSpinner.classList.add('hidden');
                    }
                } catch (error) {
                    showLoginAlert('Verbindungsfehler. Bitte versuchen Sie es später erneut.', 'danger');
                    loginBtn.disabled = false;
                    loginBtnText.textContent = 'Anmelden';
                    loginSpinner.classList.add('hidden');
                }
            });

            // Handle Delivery Form Submission
            document.getElementById('delivery-form').addEventListener('submit', async function(event) {
                event.preventDefault();
                const deliveryData = [];
                const cards = document.querySelectorAll('.order-card');
                cards.forEach(card => {
                    const id = card.getAttribute('data-order-id');
                    deliveryData.push({
                        orderId: id,
                        deliveredWagons: parseInt(document.getElementById(`delivered-wagons-${id}`).value, 10),
                        deliveredTransportDate: document.getElementById(`delivered-transport-date-${id}`).value,
                        deliveryTimeSlot: document.getElementById(`delivery-time-slot-${id}`).value,
                        deliveredDestinationNoShow: document.getElementById(`destination-no-show-${id}`).value === "Yes",
                        reasonShortDeliveryDestination: document.getElementById(`reason-short-destination-${id}`).value,
                        destinationComment: document.getElementById(`destination-comment-${id}`).value,
                    });
                });

                const payload = {
                    submissionTimestamp: new Date().toISOString(),
                    sessionToken: sessionToken,
                    deliveries: deliveryData
                };

                try {
                    const response = await fetch(ORDER_SUBMIT_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (response.ok) {
                        showAlert('Erfolg! Die Lieferungen wurden bestätigt und übermittelt.', 'success');
                        document.getElementById('delivery-form').querySelector('button[type="submit"]').disabled = true;
                    } else {
                        showAlert(`Übermittlung fehlgeschlagen. Server-Status: ${response.status}.`, 'danger');
                    }
                } catch (error) {
                    showAlert('Ein Fehler ist aufgetreten. Bitte prüfen Sie Ihre Verbindung oder wenden Sie sich an den Support.', 'danger');
                }
            });
        });
    </script>
</body>
</html>
